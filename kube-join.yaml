---
  - hosts: kube-nodes
    remote_user: '{{user}}'
    vars:
      kube_master_host: "{{ groups['kube-master'][0] }}"
      kube_master_ip: "{{ hostvars[kube_master_host]['ansible_default_ipv4']['address']}}"
    vars_files:
      - vars.yaml
    become: yes

    tasks:
      - name: make sure ufw is installed
        apt:
          name: ufw
          state: installed

      - name: open port for flannel
        ufw:
          rule: allow
          port: 8285
          proto: udp

      - name: join
        command: kubeadm join --token {{join_token}} {{kube_master_ip}} --skip-preflight-checks creates="/etc/kubernetes/kubelet.conf"
