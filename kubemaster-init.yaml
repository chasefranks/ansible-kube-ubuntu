---
  - hosts: kube-master
    remote_user: '{{user}}'
    vars_files:
      - vars.yaml
    become: yes

    tasks:
      - name: make sure ufw is installed
        apt:
          name: ufw
          state: installed

      - name: open port for flannel
        ufw:
          rule: allow
          port: 8285
          proto: udp

      - name: kubeadm init (this task may take a little while...)
        command: kubeadm init --token {{join_token}} --pod-network-cidr {{pod_network_cidr}}
        args:
          creates: /etc/kubernetes/admin.conf

      - name: allow pods to be scheduled on this master
        command: kubectl taint nodes --all dedicated-
        ignore_errors: true

      - name: template flannel pod network deployment
        template:
          src: templates/kube-flannel.yml.j2
          dest: /tmp/kube-flannel.yml

      - name: apply flannel
        command: kubectl apply -f /tmp/kube-flannel.yml
